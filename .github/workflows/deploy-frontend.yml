name: Deploy Frontend to R2

on:
  push:
    branches:
      - stage
      - prod
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      ENV: ${{ startsWith(github.ref, 'refs/heads/prod') && 'prod' || 'stage' }}
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-3' }}
      AWS_ROLE_TO_ASSUME: ${{ startsWith(github.ref, 'refs/heads/prod') && secrets.PROD_ROLE_TO_ASSUME || secrets.STAGE_ROLE_TO_ASSUME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          NEXT_PUBLIC_STAGE_BACKEND_API_URL: ${{ secrets.STAGE_BACKEND_API_URL }}
        run: |
          if [ "${ENV}" = "stage" ]; then
            npm run build:stage --workspace frontend
          else
            npm run build:prod --workspace frontend
          fi

      - name: Deploy to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ""
          AWS_REGION: auto
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          if [ -z "${R2_ENDPOINT_URL}" ]; then
            echo "R2_ENDPOINT_URL must be set as a secret." >&2
            exit 1
          fi
          if [ "${ENV}" = "stage" ]; then
            R2_BUCKET=politopics-frontend-stage
          else
            R2_BUCKET=politopics-frontend-prod
          fi

          # 1. Static assets (_next folder) are hashed, so set permanent cache (1 year)
          aws s3 sync frontend/out/_next "s3://${R2_BUCKET}/_next" \
            --endpoint-url "${R2_ENDPOINT_URL}" \
            --cache-control "public, max-age=31536000, immutable"

          # 2. HTML and other files should not be cached (always check for latest)
          aws s3 sync frontend/out "s3://${R2_BUCKET}" \
            --endpoint-url "${R2_ENDPOINT_URL}" \
            --exclude "_next/*" \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ] || [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID must be set as secrets." >&2
            exit 1
          fi
          wrangler deploy --env "${ENV}" --config wrangler.toml

      - name: Purge Cloudflare Cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -n "${CLOUDFLARE_ZONE_ID}" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
          fi

      - name: Verify frontend health
        env:
          ENV: ${{ env.ENV }}
          STAGE_FRONTEND_URL: ${{ secrets.STAGE_FRONTEND_URL }}
        run: |
          set -euo pipefail

          if [ "${ENV}" = "prod" ]; then
            frontend_url="https://politopics.net/"
          else
            if [ -z "${STAGE_FRONTEND_URL:-}" ]; then
              echo "STAGE_FRONTEND_URL secret is required for stage frontend health check" >&2
              exit 1
            fi

            frontend_url="${STAGE_FRONTEND_URL}"
          fi

          echo "Checking frontend health at ${frontend_url}"
          curl -fsSI --retry 4 --retry-delay 2 --retry-all-errors "${frontend_url}"

      - name: Configure AWS credentials for cache refresh
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          role-session-name: politopics-frontend-cache
          aws-region: ${{ env.AWS_REGION }}

      - name: Trigger headlines cache refresh
        env:
          TARGET_ENV: ${{ env.ENV }}
        run: |
          FUNCTION_NAME="politopics-headlines-cron-${TARGET_ENV}"
          echo "Invoking Lambda: ${FUNCTION_NAME}"
          aws lambda invoke --function-name "${FUNCTION_NAME}" --cli-binary-format raw-in-base64-out --payload '{}' response.json
          cat response.json
