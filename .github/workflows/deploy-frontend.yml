name: Deploy Frontend to R2

on:
  push:
    branches:
      - stage
      - prod
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      ENV: ${{ startsWith(github.ref, 'refs/heads/prod') && 'prod' || 'stage' }}
      AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-3' }}
      AWS_ROLE_TO_ASSUME: ${{ startsWith(github.ref, 'refs/heads/prod') && secrets.PROD_ROLE_TO_ASSUME || secrets.STAGE_ROLE_TO_ASSUME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          role-session-name: politopics-frontend-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init (read state)
        working-directory: terraform
        run: |
          terraform init -backend-config="backends/${ENV}.hcl"

      - name: Fetch backend API URL
        id: tf-output
        working-directory: terraform
        run: |
          API_URL=$(terraform output -raw backend_api_url)
          echo "BACKEND_API_URL=${API_URL}" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ env.BACKEND_API_URL }}
        run: |
          if [ "${ENV}" = "stage" ]; then
            npm run build:stage --workspace frontend
          else
            npm run build:prod --workspace frontend
          fi

      - name: Deploy to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ""
          AWS_REGION: auto
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          if [ -z "${R2_ENDPOINT_URL}" ]; then
            echo "R2_ENDPOINT_URL must be set as a secret." >&2
            exit 1
          fi
          if [ "${ENV}" = "stage" ]; then
            R2_BUCKET=politopics-frontend-stage
          else
            R2_BUCKET=politopics-frontend-prod
          fi
          aws s3 sync frontend/out "s3://${R2_BUCKET}" --delete --endpoint-url "${R2_ENDPOINT_URL}"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ] || [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID must be set as secrets." >&2
            exit 1
          fi
          wrangler deploy --env "${ENV}" --config wrangler.toml
